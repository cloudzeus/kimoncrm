import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/auth';

const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const { infrastructureBrief, technicalBrief, buildings } = body;

    if (!infrastructureBrief && !technicalBrief) {
      return NextResponse.json(
        { error: 'At least one brief description is required' },
        { status: 400 }
      );
    }

    // Build infrastructure context from buildings
    let infrastructureContext = '';
    if (buildings && buildings.length > 0) {
      infrastructureContext = buildings.map((b: any) => {
        const floorsCount = b.floors?.length || 0;
        const roomsCount = b.floors?.reduce((sum: number, f: any) => sum + (f.rooms?.length || 0), 0) || 0;
        return `ÎšÏ„Î¯ÏÎ¹Î¿: ${b.name}, ${floorsCount} ÏŒÏÎ¿Ï†Î¿Î¹, ${roomsCount} Ï‡ÏÏÎ¿Î¹`;
      }).join('; ');
    }

    // Construct AI prompt
    const prompt = `Î•Î¯ÏƒÎ±Î¹ Ï„ÎµÏ‡Î½Î¹ÎºÏŒÏ‚ ÏƒÏÎ¼Î²Î¿Ï…Î»Î¿Ï‚ Ï„Î·Î»ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¹ÏÎ½ ÎºÎ±Î¹ Î´Î¹ÎºÏ„ÏÏ‰Î½. Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Î¼Î¹Î± ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ® Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® Î³Î¹Î± Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¿Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬.

Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™Î•Î£ Î•Î¡Î“ÎŸÎ¥:
${infrastructureBrief ? `\nÎ¥Ï€Î¿Î´Î¿Î¼Î®: ${infrastructureBrief}` : ''}
${technicalBrief ? `\nÎ¤ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Î‘Ï€Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚: ${technicalBrief}` : ''}
${infrastructureContext ? `\nÎ”Î¿Î¼Î® ÎšÏ„Î¹ÏÎ¯Ï‰Î½: ${infrastructureContext}` : ''}

ÎŸÎ”Î—Î“Î™Î•Î£:
- Î“ÏÎ¬ÏˆÎµ Î¼Î¹Î± Ï€Î»Î®ÏÎ· Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® 800-1200 Î»Î­Î¾ÎµÏ‰Î½
- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ® Î³Î»ÏÏƒÏƒÎ±
- Î ÎµÏÎ¯Î³ÏÎ±ÏˆÎµ Ï„Î·Î½ Ï…Ï†Î¹ÏƒÏ„Î¬Î¼ÎµÎ½Î· ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎºÎ±Î¹ Ï„Î± Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î±
- Î•Î¾Î®Î³Î·ÏƒÎµ Ï„Î·Î½ Ï€ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î· Î»ÏÏƒÎ· ÎºÎ±Î¹ Ï„Î± Î¿Ï†Î­Î»Î·
- Î‘Î½Î±Ï†Î­ÏÎ¿Ï… ÏƒÎµ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ (VoIP, IP PBX, Î´Î¿Î¼Î·Î¼Î­Î½Î· ÎºÎ±Î»Ï‰Î´Î¯Ï‰ÏƒÎ·, switches, Îº.Î»Ï€.)
- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Î•Î»Î»Î·Î½Î¹ÎºÎ¬ ÎºÎµÏ†Î±Î»Î±Î¯Î± Ï‡Ï‰ÏÎ¯Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚ Î³Î¹Î± Ï„Î¯Ï„Î»Î¿Ï…Ï‚ (Ï€.Ï‡. Î¤Î•Î§ÎÎ™ÎšÎ— Î Î•Î¡Î™Î“Î¡Î‘Î¦Î—)
- ÎœÎ—Î Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï„Î¯Ï„Î»Î¿ - Î¼ÏŒÎ½Î¿ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï„Î·Ï‚ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®Ï‚

Î“ÏÎ¬ÏˆÎµ ÎœÎŸÎÎŸ Ï„Î·Î½ Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÏƒÎµ Î•Î»Î»Î·Î½Î¹ÎºÎ¬:`;

    console.log('ğŸ¤– Calling DeepSeek API for technical description...');

    const aiResponse = await fetch(DEEPSEEK_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.7,
        max_tokens: 2000,
      }),
    });

    if (!aiResponse.ok) {
      const errorText = await aiResponse.text();
      console.error('DeepSeek API error:', errorText);
      throw new Error('Failed to generate AI description');
    }

    const aiData = await aiResponse.json();
    const technicalDescription = aiData.choices?.[0]?.message?.content || '';

    if (!technicalDescription) {
      throw new Error('No content generated by AI');
    }

    console.log('âœ… AI technical description generated successfully');

    return NextResponse.json({
      success: true,
      technicalDescription,
    });

  } catch (error: any) {
    console.error('âŒ Error generating AI technical description:', error);
    return NextResponse.json(
      {
        error: 'Failed to generate AI technical description',
        details: error.message,
      },
      { status: 500 }
    );
  }
}

